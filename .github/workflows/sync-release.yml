name: 全自动项目同步机器人

on:
  schedule:
    - cron: '0 6 * * *' # 每天北京时间 14:00 自动运行
  workflow_dispatch:    # 支持手动点击按钮触发

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # 使用你创建的 PAT 令牌，解决工作流同步权限问题
          token: ${{ secrets.SYNC_PAT }}

      - name: 配置 Git 环境
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: 同步上游代码及标签
        env:
          UPSTREAM_REPO: "MHSanaei/3x-ui"
          # 注入 PAT 用于推送操作
          GITHUB_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          git remote remove upstream || true
          git remote add upstream https://github.com/$UPSTREAM_REPO.git
          
          # 1. 同步主分支
          git fetch upstream main
          git checkout main
          git merge upstream/main --ff-only || echo "代码已是最新"
          # 使用 PAT 后，push 操作将不再受限
          git push origin main

          # 2. 同步 Tags
          git fetch upstream --tags
          git push origin --tags --force

      - name: 检查并搬运 Release 附件
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
          UPSTREAM_REPO: "MHSanaei/3x-ui"
        run: |
          LATEST_TAG=$(gh release view --repo $UPSTREAM_REPO --json tagName --template '{{.tagName}}')
          echo "上游最新版本: $LATEST_TAG"

          if gh release view $LATEST_TAG >/dev/null 2>&1; then
            echo "版本 $LATEST_TAG 已存在，跳过。"
          else
            echo "正在搬运附件..."
            mkdir -p ./downloads
            gh release download $LATEST_TAG --repo $UPSTREAM_REPO --dir ./downloads

            TITLE=$(gh release view $LATEST_TAG --repo $UPSTREAM_REPO --json name --template '{{.name}}')
            BODY=$(gh release view $LATEST_TAG --repo $UPSTREAM_REPO --json body --template '{{.body}}')

            gh release create $LATEST_TAG ./downloads/* --title "$TITLE" --notes "$BODY"
            echo "搬运完成！"
          fi
